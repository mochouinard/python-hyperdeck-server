<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<style>
.progress-wrapper {
    width:100%;
}
.progress-wrapper .progress {
    background-color:green;
    width:0%;
    padding:5px 0px 5px 0px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
</head>
<body>
<script>
var ws = null;
function del_media(file) {
	ws.send(JSON.stringify({'cmd': 'delete_media', 'filename': file}))

}
function bytesToSize(bytes) {
   var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
   if (bytes == 0) return '0 Byte';
   var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
   return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
}
$(function() {
		ws = new WebSocket("ws://" + location.host.split(':')[0] + ":8765/"), 
		messages = document.createElement('ul');
		ws.onopen = function(event) {
			ws.send(JSON.stringify({'cmd': 'load_list'}));
			ws.send(JSON.stringify({'cmd': 'disk_list'}));

		}
		ws.onmessage = function (event) {
			j = JSON.parse(event.data);
			if (j['type'] == 'media_removed') {
				ws.send(JSON.stringify({'cmd': 'load_list'}));
			} else if (j['type'] == 'disk_list') {
				list = '<ul>';
				options = '';
				$.each(j['list'], function(key, val) {
					list += '<li>' + val['location'] + ' T: ' + bytesToSize(val['usage']['total']) + ' - U: ' + bytesToSize(val['usage']['used']) + ' - F: ' + bytesToSize(val['usage']['free']) + '</li>';
					options += '<option>' + val['location'] + '</option>';
                                });
                                list += '</ul>';
                                $("#drives").html(list);
				$("#uploaddestination").html(options);
			} else if (j['type'] == 'media_list') {
				list = '<ul>';
				$.each(j['list'], function(key, val) {
					ext = "";
					if ('device' in val) 
						ext = 'EXT:';
					list += '<li>' + ext + val['filename'] + '</a> - <a target="_blank" href="videos/' + val['filename'] + '">download</a> - <a href="javascript:del_media(\'' + val['filename'] + '\');">delete</a></li>';
				});
				list += '</ul>';
				$("#files").html(list);
			} else if (j['type'] == 'event' && j['name'] == 'newmedia') {
				ws.send(JSON.stringify({'cmd': 'load_list'}));
                        	ws.send(JSON.stringify({'cmd': 'disk_list'}));
			} else {
				console.log("unknown event", event.data);
			}
			/*
			console.log(event.data);
			var messages = document.getElementsByTagName('ul')[0],
				message = document.createElement('li'),
				content = document.createTextNode(event.data);
		message.appendChild(content);
		messages.appendChild(message);
		*/
	};
//	document.body.appendChild(messages);

});

function postFile() {
    var formdata = new FormData();
    formdata.append('destination', $('#uploaddestination').val());
    formdata.append('file1', $('#file1')[0].files[0]);

    var request = new XMLHttpRequest();
    request.addEventListener("loadend", function(e) {
	ws.send(JSON.stringify({'cmd': 'load_list'}));
    });
    request.upload.addEventListener('progress', function (e) {
        var file1Size = $('#file1')[0].files[0].size;

        if (e.loaded <= file1Size) {
            var percent = Math.round(e.loaded / file1Size * 100);
            $('#progress-bar-file1').width(percent + '%').html(percent + '%');
        } 

        if(e.loaded == e.total){
            $('#progress-bar-file1').width(100 + '%').html(100 + '%');
        }
    });   

    request.open('post', '/upload');
    request.timeout = 300000;
    request.send(formdata);
}
</script>
<form id="form1">
    <select id="uploaddestination">
            <option>Internal</option>
    </select>

    <input id="file1" type="file" />
    <div class="progress-wrapper">
        <div id="progress-bar-file1" class="progress"></div>
    </div>
    <button type="button" onclick="postFile()">Upload File</button>
</form>
<div id="drives"></div>
<div id="files"></div>
</body>
</html>
