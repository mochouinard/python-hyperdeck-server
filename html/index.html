<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<style>
.progress-wrapper {
    width:100%;
}
.progress-wrapper .progress {
    background-color:green;
    width:0%;
    padding:5px 0px 5px 0px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
</head>
<body>
<script>
var ws = null;



function timeConverter(UNIX_timestamp){
  var a = new Date(UNIX_timestamp * 1000);
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var year = a.getFullYear();
  var month = months[a.getMonth()];
  var date = a.getDate();
  var hour = a.getHours();
  var min = a.getMinutes();
  var sec = a.getSeconds();
  var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
  return time;
}

// List of HTML entities for escaping.
var htmlEscapes = {
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  "'": '&#x27;',
  '/': '&#x2F;'
};

// Regex containing the keys listed immediately above.
var htmlEscaper = /[&<>"'\/]/g;

// Escape a string for HTML interpolation.
escapeHTML = function(string) {
  return ('' + string).replace(htmlEscaper, function(match) {
    return htmlEscapes[match];
  });
};


function del_media(file) {
	ws.send(JSON.stringify({'cmd': 'delete_media', 'filename': file}))

}
function bytesToSize(bytes) {
   var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
   if (bytes == 0) return '0 Byte';
   var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
   return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
}
$(function() {
		ws = new WebSocket("ws://" + location.host.split(':')[0] + ":8765/"), 
		messages = document.createElement('ul');
		ws.onopen = function(event) {
			ws.send(JSON.stringify({'cmd': 'load_list'}));
			ws.send(JSON.stringify({'cmd': 'disk_list'}));

		}
		ws.onmessage = function (event) {
			j = JSON.parse(event.data);
			if (j['type'] == 'media_removed') {
				ws.send(JSON.stringify({'cmd': 'load_list'}));
			} else if (j['type'] == 'disk_list') {
				list = '<ul>';
				options = '';
				$.each(j['list'], function(key, val) {
					list += '<li>' + val['location'] + ' T: ' + bytesToSize(val['usage']['total']) + ' - U: ' + bytesToSize(val['usage']['used']) + ' - F: ' + bytesToSize(val['usage']['free']) + '</li>';
					options += '<option>' + val['location'] + '</option>';
                                });
                                list += '</ul>';
                                $("#drives").html(list);
				$("#uploaddestination").html(options);
			} else if (j['type'] == 'media_list') {
				list = '<ul>';
				$.each(j['list'], function(key, val) {
					ext = "";
					if ('device' in val) 
						ext = 'EXT:';
					list += '<li>' + ext + val['filename'] + '</a> - <a target="_blank" href="videos/' + val['filename'] + '">download</a> - <a href="javascript:del_media(\'' + val['filename'] + '\');">delete</a></li>';
				});
				list += '</ul>';
				$("#files").html(list);
			} else if (j['type'] == 'event' && j['name'] == 'newmedia') {
				ws.send(JSON.stringify({'cmd': 'load_list'}));
                        	ws.send(JSON.stringify({'cmd': 'disk_list'}));
			} else if (j['type'] == 'upgrade_info') {
				git = j['git'];
				out = "";
				if (j['git']['is_dirty']) {
					out += 'WARNING: Local change to software exist... Upgrade can cause issues</br>';
				}
				if (j['git']['untracked_files'].length > 0) {
					out += 'WARNING: Untracked files exist in software... Upgrade can cause issues</br>';
				}
				out += "<ul>";
				$.each(j['git']['new_commits'], function(i, val) {
					out += '<li>' + timeConverter(val.authored_date) + ': ' + val.author_name + escapeHTML(' <' + val.author_email + '> ') + val.message + '</li>';
				});
				out += '</ul>';
				if (j['git']['origin_commit'] != j['git']['head_commit']) {
					out += 'New Version Available... Upgrade ? </br>';
				}
				if (j['git']['runtime_head_commit'] != j['git']['head_commit']) {
					out += 'Running a different local version... Restart ?</br>';	
				}
				$('#new_log').html(out);

				console.log(j);
			} else if (j['type'] == 'upgrade_completed') {
				ws.send(JSON.stringify({cmd: 'upgrade_check'}));
			} else {
				console.log("unknown event", event.data);
			}
			/*
			console.log(event.data);
			var messages = document.getElementsByTagName('ul')[0],
				message = document.createElement('li'),
				content = document.createTextNode(event.data);
		message.appendChild(content);
		messages.appendChild(message);
		*/
	};
//	document.body.appendChild(messages);

});

function timeLeft(t) {
  var days = Math.floor(t / (1000 * 60 * 60 * 24));
  var hours = Math.floor((t % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  var minutes = Math.floor((t % (1000 * 60 * 60)) / (1000 * 60));
  var seconds = Math.floor((t % (1000 * 60)) / 1000);
	var ret = '';
	if (days != 0)
		ret += days + "d ";
	if (hours != 0)
		ret += hours + "h ";
	ret += minutes + "m ";
	ret += seconds + 's ';
	return ret;
}
function postFile() {
    var formdata = new FormData();
    formdata.append('destination', $('#uploaddestination').val());
    formdata.append('file1', $('#file1')[0].files[0]);

    var request = new XMLHttpRequest();
    request.addEventListener("loadend", function(e) {
	ws.send(JSON.stringify({'cmd': 'load_list'}));
    });
    var first = null;
    var last_update = null;
    var last_size = null;
    var avg_speed = [];

    const arrAvg = arr => arr.reduce((a,b) => a + b, 0) / arr.length;
    request.upload.addEventListener('progress', function (e) {
        var file1Size = $('#file1')[0].files[0].size;
	if (first == null) {
		first = {'total': file1Size, 'time': window.performance.now(), 'timetime': Date.now()};
	}
        if (e.loaded <= file1Size) {
            var percent = Math.round(e.loaded / file1Size * 100);
	    if (last_update != null) {
		    //console.log(window.performance.now() - last_update);
		    s = ((e.loaded - last_size) / ((window.performance.now() - last_update)/1000.0));
		    avg_speed.push(s);
	    }
	    if (avg_speed.length > 10) {
		avg_speed.shift();
	    }
            $('#progress-bar-file1').width(percent + '%').html(percent + '%');
	    tl = ((file1Size - e.loaded) / (arrAvg(avg_speed))) * 1000.0;
            $('#speed-file1').html(bytesToSize(e.loaded) + '/' + bytesToSize(file1Size) + ' ' + bytesToSize(arrAvg(avg_speed)) + '/sec'  + ' time left: ' + timeLeft(tl));

            last_update = window.performance.now();
            last_size = e.loaded;

        } 

        if(e.loaded == e.total){
            $('#progress-bar-file1').width(100 + '%').html(100 + '%');
	    first['end'] = Date.now();
		console.log(first);
        }


    });   

    request.open('post', '/upload');
    request.timeout = 300000;
    request.send(formdata);
}
</script>
<form id="form1">
    <select id="uploaddestination">
            <option>Internal</option>
    </select>

    <input id="file1" type="file" />
    <div class="progress-wrapper">
        <div id="progress-bar-file1" class="progress"></div>
	<div id="speed-file1"></div>
    </div>
    <button type="button" onclick="postFile()">Upload File</button>
</form>
<div id="drives"></div>
<div id="files"></div>
<button onclick="ws.send(JSON.stringify({cmd: 'upgrade_check'}));">Check for upgrade</button>
<div id="upgrade">
	<div id="new_log"></div>
<button onclick="ws.send(JSON.stringify({cmd: 'upgrade_run'}));">Run Upgrade</button>
<button onclick="ws.send(JSON.stringify({cmd: 'kill'}));">Kill Restart</button>

</div>
</body>
</html>
